jQuery(document).ready(function(t){class e{constructor(){this.favorites_working=!1,this.fragment_indicator=lukio_favorites_data.fragment_indicator,this.body=t("body"),this.storage_key="lukio_favorites_fragments",this.supports_html5_storage=!0,this.test_html5_storage()}test_html5_storage(){try{this.supports_html5_storage="sessionStorage"in window&&null!==window.sessionStorage,window.sessionStorage.setItem("lukio_favorites_test","test"),window.sessionStorage.removeItem("lukio_favorites_test"),window.localStorage.setItem("lukio_favorites_test","test"),window.localStorage.removeItem("lukio_favorites_test")}catch(t){this.supports_html5_storage=!1}}clicked_favorite_button(e){if(this.favorites_working)return;this.favorites_working=!0;let o=t(`.lukio_favorites_button[data-post-id="${e.data("post-id")}"]`);o.addClass("working"),this.send_ajax(o,e.data("post-id"),e.data("post-type"),e.data("nonce"))}send_ajax(e,o,s,a){let i=this,r=null;t.ajax({method:"POST",url:lukio_favorites_data.ajax_url,data:{action:"lukio_favorites_button_click",post_id:o,post_type:s,nonce:a},success:function(t){t&&(r=JSON.parse(t),e.attr("data-lukio-fav",r.favorite).attr("title",r.title),i.update_menu_button(r.empty),i.update_display(r.fragments,r.favorite,r.empty,e),i.update_storage(r.fragments,r.posts,r.empty),i.update_cookie(r.cookie_data))},complete:function(){e.removeClass("working"),i.favorites_working=!1,i.body.trigger("lukio_favorites_plugin_refresh",[e,r])}})}update_menu_button(e){t(".lukio_favorites_menu_button")[e?"addClass":"removeClass"]("empty")}update_fragments(e){t.each(e,function(e,o){t(e+":not(.skip_update)").replaceWith(o)})}update_display(t,e,o,s){e||o?this.update_fragments(t):s.closest(".lukio_favorites_post").remove()}update_storage(t,e,o){if(!this.supports_html5_storage)return;let s=Date.now(),a=JSON.stringify({timestamp:s,fragments:t,empty:o,posts:e});sessionStorage.setItem(this.storage_key,a),localStorage.setItem(this.storage_key,a)}storage_updated(e){if(e.originalEvent.key!==this.storage_key)return;let o=JSON.parse(sessionStorage.getItem(this.storage_key)),s=JSON.parse(localStorage.getItem(this.storage_key));o&&o.timestamp===s.timestamp||(this.update_fragments(s.fragments),this.update_menu_button(s.empty),t(`.lukio_favorites_button:not(.${this.fragment_indicator})`).each(function(){let e=t(this);e.attr("data-lukio-fav",-1!=s.posts.indexOf(e.data("post-id"))?1:0)}))}update_cookie(t){0!=t&&(document.cookie=`${lukio_favorites_data.favorites_coockie}=${t};path=/;`)}}const o=new e;t(document).on("click",".lukio_favorites_button",function(e){e.stopPropagation(),e.preventDefault(),o.clicked_favorite_button(t(this))}),t(window).on("storage onstorage",function(t){o.storage_updated(t)})});